@@ -2042,33 +2383,60 @@
 
     @Nullable
     public Entity a(DimensionManager dimensionmanager) {
+        // CraftBukkit start
+        return teleportTo(dimensionmanager, null);
+    }
+
+    @Nullable
+    public Entity teleportTo(DimensionManager dimensionmanager, BlockPosition location) {
+        // CraftBukkit end
         if (!this.world.isClientSide && !this.dead) {
             this.world.getMethodProfiler().enter("changeDimension");
             MinecraftServer minecraftserver = this.getMinecraftServer();
             DimensionManager dimensionmanager1 = this.dimension;
             WorldServer worldserver = minecraftserver.getWorldServer(dimensionmanager1);
             WorldServer worldserver1 = minecraftserver.getWorldServer(dimensionmanager);
+            // CraftBukkit start
+            if (worldserver1 == null){
+                return null;
+            }
 
-            this.dimension = dimensionmanager;
-            this.decouple();
+            // this.dimension = dimensionmanager;
+            // this.decouple();
+            // CraftBukkit end
             this.world.getMethodProfiler().enter("reposition");
             Vec3D vec3d = this.getMot();
             float f = 0.0F;
-            BlockPosition blockposition;
+            BlockPosition blockposition = location; // CraftBukkit
 
-            if (dimensionmanager1 == DimensionManager.THE_END && dimensionmanager == DimensionManager.OVERWORLD) {
-                blockposition = worldserver1.getHighestBlockYAt(HeightMap.Type.MOTION_BLOCKING_NO_LEAVES, worldserver1.getSpawn());
-            } else if (dimensionmanager == DimensionManager.THE_END) {
-                blockposition = worldserver1.getDimensionSpawn();
+        if (blockposition == null) { // CraftBukkit
+            if (dimensionmanager1.getType() == DimensionManager.THE_END && dimensionmanager == DimensionManager.OVERWORLD) { // CraftBukkit
+                // CraftBukkit start
+                EntityPortalEvent event = CraftEventFactory.callEntityPortalEvent(this, worldserver1, worldserver1.getHighestBlockYAt(HeightMap.Type.MOTION_BLOCKING_NO_LEAVES, worldserver1.getSpawn()), 0);
+                if (event == null) {
+                    return null;
+                }
+                worldserver1 = ((CraftWorld) event.getTo().getWorld()).getHandle();
+                blockposition = new BlockPosition(event.getTo().getX(), event.getTo().getY(), event.getTo().getZ());
+                // CraftBukkit end
+            } else if (dimensionmanager.getType() == DimensionManager.THE_END) { // CraftBukkit
+                // CraftBukkit start
+                EntityPortalEvent event = CraftEventFactory.callEntityPortalEvent(this, worldserver1, worldserver1.getDimensionSpawn() != null ? worldserver1.getDimensionSpawn() : worldserver1.getSpawn(), 0);
+                if (event == null) {
+                    return null;
+                }
+                worldserver1 = ((CraftWorld) event.getTo().getWorld()).getHandle();
+                blockposition = new BlockPosition(event.getTo().getX(), event.getTo().getY(), event.getTo().getZ());
+                // CraftBukkit end
             } else {
                 double d0 = this.locX();
                 double d1 = this.locZ();
                 double d2 = 8.0D;
 
-                if (dimensionmanager1 == DimensionManager.OVERWORLD && dimensionmanager == DimensionManager.NETHER) {
+                if (dimensionmanager1.getType() == DimensionManager.OVERWORLD && dimensionmanager.getType() == DimensionManager.NETHER) { // CraftBukkit
                     d0 /= 8.0D;
                     d1 /= 8.0D;
-                } else if (dimensionmanager1 == DimensionManager.NETHER && dimensionmanager == DimensionManager.OVERWORLD) {
+                } else if (dimensionmanager1.getType() == DimensionManager.NETHER && dimensionmanager.getType() == DimensionManager.OVERWORLD) { // CraftBukkit
                     d0 *= 8.0D;
                     d1 *= 8.0D;
                 }
@@ -2083,7 +2451,16 @@
                 Vec3D vec3d1 = this.getPortalOffset();
 
                 blockposition = new BlockPosition(d0, this.locY(), d1);
-                ShapeDetector.Shape shapedetector_shape = worldserver1.getTravelAgent().a(blockposition, vec3d, this.getPortalDirection(), vec3d1.x, vec3d1.y, this instanceof EntityHuman);
+                // CraftBukkit start
+                EntityPortalEvent event = CraftEventFactory.callEntityPortalEvent(this, worldserver1, blockposition, 128);
+                if (event == null) {
+                    return null;
+                }
+                worldserver1 = ((CraftWorld) event.getTo().getWorld()).getHandle();
+                blockposition = new BlockPosition(event.getTo().getX(), event.getTo().getY(), event.getTo().getZ());
+                int searchRadius = event.getSearchRadius();
+                // CraftBukkit end
+                ShapeDetector.Shape shapedetector_shape = worldserver1.getTravelAgent().findPortal(blockposition, vec3d, this.getPortalDirection(), vec3d1.x, vec3d1.y, this instanceof EntityHuman, searchRadius); // CraftBukkit - search radius
 
                 if (shapedetector_shape == null) {
                     return null;
@@ -2093,6 +2470,13 @@
                 vec3d = shapedetector_shape.velocity;
                 f = (float) shapedetector_shape.yaw;
             }
+        } // CraftBukkit
+
+            // CraftBukkit start
+
+            this.dimension = dimensionmanager;
+            this.decouple();
+            // CraftBukkit end
 
             this.world.getMethodProfiler().exitEnter("reloading");
             Entity entity = this.getEntityType().a((World) worldserver1);
@@ -2102,6 +2486,14 @@
                 entity.setPositionRotation(blockposition, entity.yaw + f, entity.pitch);
                 entity.setMot(vec3d);
                 worldserver1.addEntityTeleport(entity);
+                // CraftBukkit start - Forward the CraftEntity to the new entity
+                this.getBukkitEntity().setHandle(entity);
+                entity.bukkitEntity = this.getBukkitEntity();
+
+                if (this instanceof EntityInsentient) {
+                    ((EntityInsentient)this).unleash(true, false); // Unleash to prevent duping of leads.
+                }
+                // CraftBukkit end
             }
 
             this.dead = true;