@@ -27,10 +41,10 @@
     protected static final DataWatcherObject<NBTTagCompound> bt = DataWatcher.a(EntityHuman.class, DataWatcherRegistry.p);
     private long e;
     public final PlayerInventory inventory = new PlayerInventory(this);
-    protected InventoryEnderChest enderChest = new InventoryEnderChest();
+    protected InventoryEnderChest enderChest = new InventoryEnderChest(this); // CraftBukkit - add "this" to constructor
     public final ContainerPlayer defaultContainer;
     public Container activeContainer;
-    protected FoodMetaData foodData = new FoodMetaData();
+    protected FoodMetaData foodData = new FoodMetaData(this); // CraftBukkit - add "this" to constructor
     protected int bz;
     public float bA;
     public float bB;
@@ -1139,15 +1269,15 @@
         return this.bT;
     }
 
-    public Either<EntityHuman.EnumBedResult, Unit> sleep(BlockPosition blockposition) {
-        EnumDirection enumdirection = (EnumDirection) this.world.getType(blockposition).get(BlockFacingHorizontal.FACING);
-
+    // CraftBukkit start - moved bed result checks from below into separate method
+    private Either<EntityHuman.EnumBedResult, Unit> getBedResult(BlockPosition blockposition, EnumDirection enumdirection) {
         if (!this.world.isClientSide) {
             if (this.isSleeping() || !this.isAlive()) {
                 return Either.left(EntityHuman.EnumBedResult.OTHER_PROBLEM);
             }
 
-            if (!this.world.worldProvider.isOverworld()) {
+            // CraftBukkit - moved world and biome check from BlockBed interact handling here
+            if (!world.worldProvider.canRespawn() || world.getBiome(blockposition) == Biomes.NETHER || !this.world.worldProvider.isOverworld()) {
                 return Either.left(EntityHuman.EnumBedResult.NOT_POSSIBLE_HERE);
             }
 
@@ -1177,6 +1307,34 @@
                 }
             }
         }
+        return Either.right(Unit.INSTANCE);
+    }
+
+    public Either<EntityHuman.EnumBedResult, Unit> sleep(BlockPosition blockposition) {
+        // CraftBukkit start - moved checks into separate method above, add force
+        return this.sleep(blockposition, false);
+    }
+
+    public Either<EntityHuman.EnumBedResult, Unit> sleep(BlockPosition blockposition, boolean force) {
+        EnumDirection enumdirection = (EnumDirection) this.world.getType(blockposition).get(BlockFacingHorizontal.FACING);
+        Either<EntityHuman.EnumBedResult, Unit> bedResult = this.getBedResult(blockposition, enumdirection);
+
+        if (bedResult.left().orElse(null) == EntityHuman.EnumBedResult.OTHER_PROBLEM) {
+            return bedResult; // return immediately if the result is not bypassable by plugins
+        }
+
+        if (force) {
+            bedResult = Either.right(Unit.INSTANCE);
+        }
+
+        if (this.getBukkitEntity() instanceof Player) {
+            bedResult = org.bukkit.craftbukkit.event.CraftEventFactory.callPlayerBedEnterEvent(this, blockposition, bedResult);
+
+            if (bedResult.left().isPresent()) {
+                return bedResult;
+            }
+        }
+        // CraftBukkit end
 
         this.entitySleep(blockposition);
         this.sleepTicks = 0;
@@ -1211,11 +1369,28 @@
     }
 
     public void wakeup(boolean flag, boolean flag1) {
+        BlockPosition bedPosition = this.getBedPosition().orElse(null); // CraftBukkit
         super.entityWakeup();
         if (this.world instanceof WorldServer && flag1) {
             ((WorldServer) this.world).everyoneSleeping();
         }
 
+        // CraftBukkit start - fire PlayerBedLeaveEvent
+        if (this.getBukkitEntity() instanceof Player) {
+            Player player = (Player) this.getBukkitEntity();
+
+            org.bukkit.block.Block bed;
+            if (bedPosition != null) {
+                bed = this.world.getWorld().getBlockAt(bedPosition.getX(), bedPosition.getY(), bedPosition.getZ());
+            } else {
+                bed = this.world.getWorld().getBlockAt(player.getLocation());
+            }
+
+            PlayerBedLeaveEvent event = new PlayerBedLeaveEvent(player, bed, true);
+            this.world.getServer().getPluginManager().callEvent(event);
+        }
+        // CraftBukkit end
+
         this.sleepTicks = flag ? 0 : 100;
     }
 
@@ -1267,9 +1442,11 @@
 